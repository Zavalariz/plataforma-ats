<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS Elite Terminal | Operativa Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050a0a; color: #e2e8f0; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; overflow: hidden; }
        .glass-nav { background: rgba(5, 10, 10, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sidebar { background: #080d0d; border-right: 1px solid rgba(255,255,255,0.05); border-left: 1px solid rgba(255,255,255,0.05); }
        .neon-green { color: #00ffa3; text-shadow: 0 0 10px rgba(0, 255, 163, 0.3); }
        /* Contenedor con altura forzada para que el gráfico no desaparezca */
        #chart-main { width: 100%; height: 100%; min-height: 400px; background: #050a0a; }
        .btn-action { transition: all 0.2s ease; font-weight: 800; font-style: italic; text-transform: uppercase; }
        input, select { background: #0c1414 !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; }
    </style>
</head>
<body x-data="terminalLogic()" class="h-screen flex flex-col">

    <header class="h-14 glass-nav flex justify-between items-center px-6 z-50">
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-white text-black font-black text-[10px] flex items-center justify-center rounded">ATS</div>
                <span class="text-xs font-black italic uppercase tracking-tighter">Elite <span class="neon-green">Terminal</span></span>
            </div>
            <nav class="flex gap-6 text-[9px] font-bold uppercase tracking-widest text-gray-500">
                <a href="dashboard.html" class="hover:text-white transition">Dashboard</a>
                <span class="text-white border-b border-[#00ffa3] pb-1">Operar</span>
            </nav>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <div class="text-[7px] text-gray-500 font-bold uppercase">Cuenta Real</div>
                <div class="text-white font-bold text-sm leading-none">$<span x-text="balance">4,779.87</span></div>
            </div>
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-gray-800 to-gray-700 border border-white/10 flex items-center justify-center text-[10px] font-bold text-white">RS</div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 sidebar p-5 flex flex-col gap-6">
            <div>
                <h4 class="text-[8px] font-black text-gray-500 uppercase tracking-widest mb-4">Configurações da IA</h4>
                <div class="text-xl font-bold">$0 <span class="text-[10px] text-gray-500 font-normal">(0%)</span></div>
            </div>
            <div>
                <label class="text-[8px] font-bold text-gray-500 uppercase mb-2 block">Mercado</label>
                <select class="w-full p-3 rounded-lg text-xs font-bold outline-none">
                    <option>Volatility 100 Index</option>
                </select>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-[#0c1414] p-2 rounded border border-white/5 text-center">
                    <span class="text-[7px] text-gray-500 uppercase block">Quantia</span>
                    <span class="text-[10px] font-bold">$1</span>
                </div>
                <div class="bg-[#0c1414] p-2 rounded border border-white/5 text-center">
                    <span class="text-[7px] text-gray-500 uppercase block">Meta</span>
                    <span class="text-[10px] font-bold">$20</span>
                </div>
                <div class="bg-[#0c1414] p-2 rounded border border-white/5 text-center">
                    <span class="text-[7px] text-gray-500 uppercase block">Perda</span>
                    <span class="text-[10px] font-bold">$1k</span>
                </div>
            </div>
            <button class="mt-auto w-full bg-[#8b5cf6] text-white py-4 rounded-xl font-black text-xs uppercase italic shadow-lg shadow-purple-500/20">▶ Iniciar Robô</button>
        </aside>

        <main class="flex-1 flex flex-col bg-[#050a0a] relative">
            <div class="h-10 border-b border-white/5 flex items-center px-6 gap-4 text-[9px] font-bold uppercase tracking-widest text-gray-400">
                <span class="text-[#00ffa3] border-b border-[#00ffa3]">Candlestick</span>
                <span>Dígitos</span>
            </div>
            <div class="flex-1 relative overflow-hidden">
                <div id="chart-main"></div>
                <div class="absolute top-6 left-6 z-20">
                    <div class="text-[10px] font-bold text-gray-500 uppercase">Volatility 100 Index</div>
                    <div class="text-3xl font-black italic tracking-tighter" :class="priceColor" x-text="currentPrice">---</div>
                </div>
            </div>
        </main>

        <aside class="w-72 sidebar p-6 flex flex-col gap-8">
            <div class="text-center">
                <h4 class="text-[8px] font-black text-gray-500 uppercase tracking-widest mb-2">Modo Manual</h4>
                <div class="text-2xl font-black">$0 <span class="text-xs text-gray-500 font-normal">(0%)</span></div>
            </div>
            <div class="space-y-4">
                <button @click="executeTrade('call')" class="w-full bg-[#00ffa3] text-black py-5 rounded-2xl flex flex-col items-center btn-action shadow-lg shadow-emerald-500/20">
                    <span class="text-sm">↗ RISE</span>
                    <span class="text-[9px] opacity-70">Payout: 95%</span>
                </button>
                <button @click="executeTrade('put')" class="w-full bg-[#ff3355] text-white py-5 rounded-2xl flex flex-col items-center btn-action shadow-lg shadow-red-500/20">
                    <span class="text-sm">↘ FALL</span>
                    <span class="text-[9px] opacity-70">Payout: 95%</span>
                </button>
            </div>
            <div class="mt-4">
                <label class="text-[8px] font-bold text-gray-500 uppercase mb-2 block text-center">Duração</label>
                <div class="flex items-center bg-[#0c1414] rounded-lg border border-white/10 overflow-hidden">
                    <button class="px-4 py-3 hover:bg-white/5">-</button>
                    <input type="text" value="1" class="w-full text-center bg-transparent border-none text-xs font-bold text-white">
                    <button class="px-4 py-3 hover:bg-white/5">+</button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        function terminalLogic() {
            return {
                balance: '4,779.87',
                currentPrice: 'Cargando...',
                priceColor: 'text-white',
                lineSeries: null,
                socket: null,

                init() {
                    // Timeout para asegurar que el div #chart-main exista en el DOM
                    setTimeout(() => {
                        this.setupChart();
                        this.connectDeriv();
                    }, 500);
                },

                setupChart() {
                    const container = document.getElementById('chart-main');
                    const chart = LightweightCharts.createChart(container, {
                        layout: { background: { color: '#050a0a' }, textColor: '#555' },
                        grid: { vertLines: { visible: false }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
                        timeScale: { visible: true, borderColor: 'rgba(255,255,255,0.05)' },
                        rightPriceScale: { borderColor: 'rgba(255,255,255,0.05)' },
                    });

                    this.lineSeries = chart.addAreaSeries({
                        lineColor: '#00ffa3',
                        topColor: 'rgba(0, 255, 163, 0.2)',
                        bottomColor: 'rgba(0, 255, 163, 0.0)',
                        lineWidth: 2,
                    });

                    // Ajuste automático si cambias el tamaño de la ventana
                    new ResizeObserver(() => {
                        chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
                    }).observe(container);
                },

                connectDeriv() {
                    const params = new URLSearchParams(window.location.search);
                    const token = params.get('token1');
                    this.socket = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=119907');

                    this.socket.onopen = () => {
                        if(token) this.socket.send(JSON.stringify({ "authorize": token }));
                        this.socket.send(JSON.stringify({ "ticks": "R_100" }));
                    };

                    this.socket.onmessage = (msg) => {
                        const data = JSON.parse(msg.data);
                        if (data.tick) {
                            const price = data.tick.quote;
                            this.priceColor = price > parseFloat(this.currentPrice) ? 'text-[#00ffa3]' : 'text-red-500';
                            this.currentPrice = price.toFixed(4);
                            this.lineSeries.update({ time: data.tick.epoch, value: price });
                        }
                        if (data.msg_type === 'authorize') {
                            this.socket.send(JSON.stringify({ "balance": 1, "subscribe": 1 }));
                        }
                        if (data.msg_type === 'balance') {
                            this.balance = data.balance.balance.toLocaleString(undefined, {minimumFractionDigits: 2});
                        }
                    };
                },

                executeTrade(type) {
                    alert('Ejecutando operación ' + type + ' en Volatility 100...');
                }
            }
        }
    </script>
</body>
</html>
